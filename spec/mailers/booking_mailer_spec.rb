require "rails_helper"

RSpec.describe BookingMailer, type: :mailer do
  
  let(:stops) {
    [
      FactoryGirl.create(:stop, minutes_from_last_stop: nil, position: 1,
        place: FactoryGirl.create(:place, name: 'Pickup Stop'),
        landmarks: FactoryGirl.create_list(:landmark, 1, name: 'Pickup Landmark')
      ),
      FactoryGirl.create(:stop, minutes_from_last_stop: 40, position: 2),
      FactoryGirl.create(:stop, minutes_from_last_stop: 20, position: 3),
      FactoryGirl.create(:stop, minutes_from_last_stop: 10, position: 4),
      FactoryGirl.create(:stop, minutes_from_last_stop: 15, position: 5,
        place: FactoryGirl.create(:place, name: 'Dropoff Stop'),
        landmarks: FactoryGirl.create_list(:landmark, 1, name: 'Pickup Landmark')
      )
    ]
  }
  let(:route) { FactoryGirl.create(:route, stops: stops) }
  let(:journey) { FactoryGirl.create(:journey, route: route, start_time: DateTime.parse('2017-01-01T10:00:00')) }
  let(:booking) {
    FactoryGirl.create(:booking,
      journey: journey,
      pickup_stop: stops.first,
      dropoff_stop: stops.last,
      passenger_name: 'Me',
      phone_number: '12345',
      pickup_landmark: stops.first.landmarks.first,
      dropoff_landmark: stops.last.landmarks.first,
      email: 'hello@example.com'
    )
  }
  
  let(:body) { Nokogiri::HTML(mail.body.encoded).text.squish }
  
  before do
    booking.pickup_landmark.name = 'Pickup Landmark'
    booking.pickup_landmark.save
    booking.dropoff_landmark.name = 'Dropoff Landmark'
    booking.dropoff_landmark.save
  end
  
  describe 'with a single journey' do
    
    describe '#booking_confirmed' do
      
      let(:mail) { BookingMailer.booking_confirmed('booking_id' => booking.id) }
      
      it 'renders the headers' do
        expect(mail.subject).to eq('A new booking has been confirmed')
        expect(mail.to).to eq([booking.journey.supplier.email])
        expect(mail.from).to eq([ENV['RIDE_ADMIN_EMAIL']])
      end
      
      it 'renders the body' do
        expect(body).to match(/A new booking has been confirmed/)
        expect(body).to match(/Name: Me/)
        expect(body).to match(/Phone Number: 12345/)
        expect(body).to match(/Travelling at 10:00am on Sunday, 1 Jan/)
        expect(body).to match(/From: Pickup Stop/)
        expect(body).to match(/To: Dropoff Stop/)
        expect(body).to match(/Pickup Landmark: Pickup Landmark/)
        expect(body).to match(/Dropoff Landmark: Dropoff Landmark/)
        expect(body).to match(/Amount £2.50/)
        expect(body).to match(/This is a single journey/)
      end
      
    end
    
    describe '#booking_cancelled' do
      
      let(:mail) { BookingMailer.booking_cancelled('booking_id' => booking.id) }
      
      it 'renders the headers' do
        expect(mail.subject).to eq('Booking cancelled')
        expect(mail.to).to eq([booking.journey.supplier.email])
        expect(mail.from).to eq([ENV['RIDE_ADMIN_EMAIL']])
      end
      
      it 'renders the body' do
        expect(body).to match(/A booking has been cancelled/)
        expect(body).to match(/Name: Me/)
        expect(body).to match(/Phone Number: 12345/)
        expect(body).to match(/Travelling at 10:00am on Sunday, 1 Jan/)
        expect(body).to match(/From: Pickup Stop/)
        expect(body).to match(/To: Dropoff Stop/)
        expect(body).to match(/Pickup Landmark: Pickup Landmark/)
        expect(body).to match(/Dropoff Landmark: Dropoff Landmark/)
        expect(body).to match(/This is a single journey/)
      end
      
    end
    
    describe '#user_confirmation' do
      
      let(:mail) { BookingMailer.user_confirmation('booking_id' => booking.id) }
      
      it 'renders the headers' do
        expect(mail.subject).to eq('Your Ride booking confirmation')
        expect(mail.to).to eq([booking.email])
        expect(mail.from).to eq([ENV['RIDE_ADMIN_EMAIL']])
      end
      
      it 'renders the body' do
        expect(body).to match(/Hello Me/)
        expect(body).to match(/Your Ride booking from Pickup Stop to Dropoff Stop for 1 passenger is confirmed/)
        expect(body).to match(/Your vehicle will collect you from Pickup Landmark, Pickup Stop/)
        expect(body).to match(/on Sunday, 1 Jan/)
        expect(body).to match(/between 9:50am – 10:10am/)
      end
      
    end
    
  end
  
  describe 'with a return journey' do
    before do
      booking.return_journey = FactoryGirl.create(:journey,
        route: route,
        start_time: DateTime.parse('2017-01-01T15:00:00'),
        reversed: true
      )
      booking.save
    end
    
    describe '#booking_confirmed' do
      
      let(:mail) { BookingMailer.booking_confirmed('booking_id' => booking.id) }
      
      it 'renders the body' do
        expect(body).to match(/Return Journey/)
        expect(body).to match(/Travelling at 3:00pm on Sunday, 1 Jan/)
        expect(body).to match(/From: Dropoff Stop/)
        expect(body).to match(/To: Pickup Stop/)
        expect(body).to match(/Pickup Landmark: Dropoff Landmark/)
        expect(body).to match(/Dropoff Landmark: Pickup Landmark/)
        expect(body).to match(/Amount £3.50/)
        expect(body).to match(/This is a return journey/)
      end
      
    end
    
    describe '#user_confirmation' do
      
      let(:mail) { BookingMailer.user_confirmation('booking_id' => booking.id) }
      
      it 'renders the body' do
        expect(body).to match(/and returning from Dropoff Landmark, Dropoff Stop/)
        expect(body).to match(/on Sunday, 1 Jan/)
        expect(body).to match(/between 2:50pm – 3:10pm/)
      end
      
    end
    
  end
  
end
