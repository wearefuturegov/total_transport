<% content_for :js do %>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCStCdohZX5YZIQ9lbl1FJL1imDPF8EY5w&callback=initMap&libraries=drawing,geometry" async defer></script>
  <script type="text/javascript">
  var map
    function initMap() {
      var geoJson = <%= @stop.polygon.to_json.html_safe %>;
      map = new google.maps.Map(document.getElementById("map"), {
        scrollwheel: false,
        streetViewControl: false,
        disableDefaultUI: true
      });
      map.data.addGeoJson(geoJson);
      var polygon_feature;
      map.data.forEach(function(feature) {polygon_feature = feature.getGeometry()});
      var bounds = new google.maps.LatLngBounds();
      polygon_feature.forEachLatLng(function(ll) {bounds.extend(ll)});
      tightFitBounds(map, bounds);

      var polygon = new google.maps.Polygon({
        paths: polygon_feature.getArray()[0].getArray()
      });

      <% if @map_type == 'pickup' %>
        $('<div/>').addClass('centerMarker').html('Pickup').appendTo(map.getDiv());
      <% else %>
        $('<div/>').addClass('centerMarker dropoff').html('Dropoff').appendTo(map.getDiv());
      <% end %>

      var last_position = map.getCenter();

      map.addListener('center_changed', function() {
        if(!google.maps.geometry.poly.containsLocation(map.getCenter(), polygon)) {
          map.setCenter(last_position);
        } else {
          last_position = map.getCenter();
          <% if @map_type == 'pickup' %>
            $('#booking_pickup_lat').val(map.getCenter().lat());
            $('#booking_pickup_lng').val(map.getCenter().lng());
          <% else %>
            $('#booking_dropoff_lat').val(map.getCenter().lat());
            $('#booking_dropoff_lng').val(map.getCenter().lng());
          <% end %>
        }
      });

      google.maps.event.addListenerOnce(map, 'idle', function(){
        $('#map .centerMarker').css('margin-left', ($('#map .centerMarker').outerWidth()/2)*-1);
        $('#map .centerMarker').css('margin-top', ($('#map .centerMarker').outerHeight()+10)*-1);
      });

      map.addListener('dragstart', function() {
        $('.single-landmark').each(function() {
          $(this).removeClass('chosen hover');
        });
        $('#choose-stop').click().removeClass('searching');
        $('#choose-stop .dot').removeClass('loader');

        $('#choose-stop').addClass('chosen').addClass('searching');
        $('#choose-stop .dot').addClass('loader');
        $('#choose-stop span').html('Searching for place...');
      })

      map.addListener('dragend', function() {
        var geocoder = new google.maps.Geocoder;
        geocoder.geocode({'location': map.getCenter()}, function(results, status) {
          $('#choose-stop').removeClass('searching').addClass('final');
          $('.edit_booking input[type="submit"]').attr("disabled", false).removeClass('disabled');
          $('#choose-stop .dot').removeClass('loader');
          var pin_name
          if (status === 'OK') {
            console.log(results);
            if (results[0]) {
              pin_name = results[0].address_components[0].long_name + ', ' + results[0].address_components[1].long_name + ', ' + results[0].address_components[2].long_name;
            } else {
              pin_name = 'Your pin location';
            }
          } else {
            pin_name = 'Your pin location';
          }
          $('#choose-stop span').html(pin_name);
          <% if @map_type == 'pickup' %>
            $('#booking_pickup_name').val(pin_name);
          <% else %>
            $('#booking_dropoff_name').val(pin_name);
          <% end %>
        });
      } );
    }
  </script>
<% end %>

<div class="top-sec white-block container">
  <div class="inner">

    <div class="stop-information">
      <% if @map_type == 'pickup' %>
        <% if @stop.landmarks.present? %>
          <span>Select a pickup point from the suggested landmarks in <%= @stop.name %>, or drag the map to choose your own.</span>
        <% end %>
      <% else %>
        <i class="fa fa-circle-o point origin"></i>
        <span><%= @booking.pickup_name %></span>
      <% end %>
    </div>

    <div class="landmarks">
      <div id="choose-stop" class="single-landmark chosen" data-lat="choose-own" data-long="choose-own">
        <% if @stop.landmarks.present? %>
        <i class="fa fa-circle-o point"></i>
          <span>Drag the map</span>
        <% else %>
          <% if @map_type == 'pickup' %>
          <i class="fa fa-circle-o point"></i>
            <span>Drag the map</span>
          <% else %>
            <div class="stage-2">
              <i class="fa fa-circle-o point destination"></i>
              <span>Drag the map</span>
            </div>
          <% end %>
        <% end %>
      </div>

      <% if @stop.landmarks.present? %>
        <% @stop.landmarks.each do |landmark| %>
          <div class="single-landmark" data-lat="<%= landmark.latitude %>" data-long="<%= landmark.longitude %>">
            <p>3</p>
            <i class="fa fa-circle-o point"></i>
            <span><%= landmark.name %></span>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<div class="map-cont">
  <div id="map" style="margin-bottom:0"></div>

  <div id="confirmation">
    <% if @map_type == 'pickup' %>
      <%= form_for [@route, @booking], url: save_pickup_location_route_booking_path(@route, @booking) do |form| %>
        <%= form.hidden_field :pickup_lat %>
        <%= form.hidden_field :pickup_lng %>
        <%= form.hidden_field :pickup_name %>
        <div class="box">
          <%= form.submit "Next", disabled: true, :class => 'next button alt-button disabled' %>
        </div>
      <% end %>
    <% else %>
      <%= form_for [@route, @booking], url: save_dropoff_location_route_booking_path(@route, @booking) do |form| %>
        <%= form.hidden_field :dropoff_lat %>
        <%= form.hidden_field :dropoff_lng %>
        <%= form.hidden_field :dropoff_name %>
        <div class="box">
          <%= form.submit "Next", disabled: true, :class => 'next button alt-button disabled'  %>
        </div>
      <% end %>
    <% end %>

    <% content_for :js do %>
    <script type="text/javascript">
      $(document).ready(function() {
        $('.drop_off_change').html('drop off');
        $('#map').height(($(window).height()-$('header').outerHeight())-$('.top-sec').outerHeight());
      });
      $(window).resize(function() {
        $('#map').height(($(window).height()-$('header').outerHeight())-$('.top-sec').outerHeight());
      });
      $('.single-landmark').click(function() {
        if (!$(this).hasClass('chosen')) {
          clearDots();
          $(this).addClass('chosen');

          if ($(this).data('lat') == 'choose-own') {
            map.setOptions({draggable: true, disableDoubleClickZoom: false});

            $('.edit_booking input[type="submit"]').attr("disabled", true).addClass('disabled');
            $('#choose-stop span').html('Drag the map to choose');
          } else {
            map.setOptions({draggable: false, disableDoubleClickZoom: true});

            $('.edit_booking input[type="submit"]').attr("disabled", false).removeClass('disabled');
            $('#choose-stop span').html('Choose your own');

            <% if @map_type == 'pickup' %>
              $('#booking_pickup_name').val($(this).find('span').html())
            <% else %>
              $('#booking_dropoff_name').val($(this).find('span').html())
            <% end %>

            var lat = $(this).data('lat'),
                long = $(this).data('long');
            var center = new google.maps.LatLng(lat, long);
            map.setCenter(center);
          }
        }
      });
      $('.single-landmark').hover(function() {
        $(this).addClass('hover');
      }, function() {
        $(this).removeClass('hover');
      });

      function clearDots() {
        $('.single-landmark').each(function() {
          $(this).removeClass('chosen');
          $('#choose-stop').removeClass('searching').removeClass('final');
          $('#choose-stop .dot').removeClass('loader');
        });
      }
    </script>
    <% end %>
  </div>
</div>
<!--
<%= link_to "Suggest an edit to this stop", new_route_suggested_edit_to_stop_path(@route, @booking, stop_id: @stop.id) %>
-->
